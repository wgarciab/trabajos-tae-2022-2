---
title: "Análisis de resultados escolares con reducción de la dimensionalidad y agrupamiento"
author:
  - Amilder Stewin Ospina Tobon
  - Daniel Torres Aguirre
  - Wilmar Andres Garcia Bedoya
date: '2022-09-06'
output: html_document
---

# Introducción
En este informe, examinaremos una base de datos de universidades de estados unidos, proporcionada por el Departamento de Educación de los Estados Unidos. Nuestro objetivo será realizar un agrupamiento de estas universidades, para luego caracterizar cada grupo, y determinar qué hace que un grupo sea mejor que otro.

# Carga y limpieza de datos
Inicialmente, cargamos todos los datos. La base de datos contiene 7804 observaciones de 1725 variables.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(readr)
colleges <- read_csv("exercises-cluster-analysis-exercise-2/CollegeScorecard.csv", na = c("NULL", "PrivacySuppressed"))
dictionary <- read_csv("exercises-cluster-analysis-exercise-2/CollegeScorecardDataDictionary-09-12-2015.csv")
dim(colleges)
#str(colleges)
#summary(colleges)
```
Podemos examinar las primeras 6 observaciones para hacernos una idea de la estructura de la base de datos

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
#kable(head(colleges))
DT::datatable(head(colleges), options = list(
        scrollX = TRUE,
        scrollY = "250px"))
```

Lo que haremos a continuación será quitar las columnas nulas, es decir, aquellas variables para las cuales no hay información. De esta forma, nuestra base de datos se redujo de 1725 a 551 columnas.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#sum(is.na(colleges$mn_earn_wne_p8))
colleges <- Filter(function(x)!all(is.na(x)), colleges)
dim(colleges)
#sapply(colleges, function(x) sum(is.na(x)))
```

Seleccionamos variables relevantes para nuestro problema, y las guardamos en un nuevo dataframe que contiene unicamente esas variables.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
college_subset <- colleges %>% 
    select(OPEID, INSTNM, CITY, STABBR, ZIP, 
           CONTROL, DISTANCEONLY, CITY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN,SAT_AVG, PCTFLOAN, UGDS, NPT4_PUB, NPT4_PRIV)
```

Las variables seleccionados fueron las siguientes

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dictionary %>% filter(`VARIABLE NAME` %in% names(college_subset)) %>% select(`NAME OF DATA ELEMENT`)
```

Veamos cuantos nulos hay en cada columna

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sapply(college_subset, function(x) sum(is.na(x)))
```

Reemplazamos los valores nulos de cada columna por la mediana de los demas valores existentes en esa columna.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(plyr)
library(dplyr)

college_subset2 <- college_subset[6:16]

median_values <- college_subset2 %>% 
    summarise_each(funs(median(., na.rm = TRUE)))

#median_values

college_subset2 <- college_subset2 %>%
    mutate_each(funs(if_else(is.na(.), median(., na.rm = TRUE), .)))

```

De esta manera, el número de nulos en todas las columnas queda en cero.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
sapply(college_subset2, function(x) sum(is.na(x)))
```

# PCA (Análisis de componentes principales)

Con las primeras 9 variables se explica un 92.9% de la varianza total.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
college_subset2_cent <- scale(college_subset2,center = TRUE,scale = TRUE)
college_pca <- prcomp(college_subset2_cent)
summary(college_pca)
```

# Clustering

## Seleccion del numero de clusters

Para seleccionar el número adecuado de clusters, usaremos el método de Elbow. Veamos la curva generada:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(broom)
library(tidyr)
library(dplyr)
set.seed(1234)
kclusts <- data.frame(k=4:20) %>% 
    group_by(k) %>% 
    do(kclust = kmeans(college_subset2, .$k))

clusters <- kclusts %>% group_by(k) %>% do(tidy(.$kclust[[1]]))
assignments <- kclusts %>% group_by(k) %>% do(augment(.$kclust[[1]], college_subset2))
clusterings <- kclusts %>% group_by(k) %>% do(glance(.$kclust[[1]]))

library(ggfortify)
ggplot(clusterings, aes(k, tot.withinss)) +
    geom_line(color = "blue", alpha = 0.5, size = 2) +
    geom_point(size = 0.8)
```

De acuerdo al metodo de Elbow, el número ideal de clusters es 12.

## Agrupamiento con K-means

Para realizar el agrupamiento, utilizaremos k-means con 12 clústers. El resultado del agrupamiento de puede apreciar en la siguiente figura

```{r, echo=FALSE, message=FALSE, warning=FALSE}
set.seed(1234)
autoplot(kmeans(college_subset2, 9), data = college_subset2, size = 3, alpha = 0.5) +
    ggtitle("K-Means Clustering of College Scorecard Data") +
    theme(legend.position="none")

my_kmeans <- kmeans(college_subset2, 9)
```

## Caracterización de los clusters

En el cluster ? hay muchas universidades de belleza y cosmetología

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#colleges <- colleges %>% 
#    mutate(cluster = my_kmeans$cluster) 

college_subset2 = data.frame(college_subset2)
college_subset2 <- college_subset2 %>% 
    mutate(cluster = my_kmeans$cluster) 

#colleges %>%
#    filter(cluster == 1) %>%
#    select(INSTNM)

cluster1 <- college_subset2 %>%
    filter(cluster == 1) %>%
    select(
           CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
           PCTFLOAN, UGDS)

cluster2 <- college_subset2 %>%
    filter(cluster == 2) %>%
    select(
           CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
           PCTFLOAN, UGDS)

cluster3 <- college_subset2 %>%
    filter(cluster == 3) %>%
    select(
           CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
           PCTFLOAN, UGDS)

cluster4 <- college_subset2 %>%
    filter(cluster == 4) %>%
    select(
           CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
           PCTFLOAN, UGDS)

cluster5 <- college_subset2 %>%
    filter(cluster == 5) %>%
    select(
           CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
           PCTFLOAN, UGDS)

cluster6 <- college_subset2 %>%
    filter(cluster == 6) %>%
    select(
           CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
           PCTFLOAN, UGDS)

cluster7 <- college_subset2 %>%
    filter(cluster == 7) %>%
    select(
           CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
           PCTFLOAN, UGDS)

cluster8 <- college_subset2 %>%
    filter(cluster == 8) %>%
    select(
           CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
           PCTFLOAN, UGDS)

cluster9 <- college_subset2 %>%
    filter(cluster == 9) %>%
    select(
           CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
           C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
           PCTFLOAN, UGDS)


# cluster10 <- college_subset2 %>%
#     filter(cluster == 10) %>%
#     select(
#            CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
#            C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
#            PCTFLOAN, UGDS)

# cluster11 <- college_subset2 %>%
#     filter(cluster == 11) %>%
#     select(
#            CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
#            C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
#            PCTFLOAN, UGDS)

# cluster12 <- college_subset2 %>%
#     filter(cluster == 12) %>%
#     select(
#            CONTROL, DISTANCEONLY, TUITFTE, ADM_RATE_ALL,
#            C150_4, DEBT_MDN, NPT4_PUB, NPT4_PRIV, DEBT_MDN,SAT_AVG,
#            PCTFLOAN, UGDS)


summary(cluster1)
hist(cluster1$TUITFTE)
write.csv(cluster1,"cluster1.csv", row.names = FALSE)
```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(fmsb)

#normalize <- function(x) {
#  return((x - min(x)) / (max(x) - min(x)))
#}

cluster1_means = t(colMeans(cluster1[3:11]))
cluster2_means = t(colMeans(cluster2[3:11]))
cluster3_means = t(colMeans(cluster3[3:11]))
cluster4_means = t(colMeans(cluster4[3:11]))
cluster5_means = t(colMeans(cluster5[3:11]))
cluster6_means = t(colMeans(cluster6[3:11]))
cluster7_means = t(colMeans(cluster7[3:11]))
cluster8_means = t(colMeans(cluster8[3:11]))
cluster9_means = t(colMeans(cluster9[3:11]))
#cluster10_means = t(colMeans(cluster10[3:11]))
#cluster11_means = t(colMeans(cluster11[3:11]))
#cluster12_means = t(colMeans(cluster12[3:11]))


df = data.frame()
df = rbind(df, cluster1_means)
df = rbind(df, cluster2_means)
df = rbind(df, cluster3_means)
df = rbind(df, cluster4_means)
df = rbind(df, cluster5_means)
df = rbind(df, cluster6_means)
df = rbind(df, cluster7_means)
df = rbind(df, cluster8_means)
df = rbind(df, cluster9_means)
#df = rbind(df, cluster10_means)
#df = rbind(df, cluster11_means)
#df = rbind(df, cluster12_means)

df_norm <- as.data.frame(apply(df[, 1:9], 2, function(x) (x - min(x))/(max(x)-min(x))))

df_norm <- rbind(rep(max(df_norm), 9), rep(0, 9), df_norm)

radarchart(df_norm, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1:12,
           plwd = 2)

legend(x=1.15, 
       y=1.35, 
       legend = rownames(df_norm[-c(1,2),]-2),
       bty = "n", pch=20 , col = 1:12, cex = 1.05, pt.cex = 1.5)
```

## Descripcion de los grupos

En el cluster 1, hay una masiva tasa de admisión, cercana al 90%, pero en todos los demás aspectos presenta valores muy bajos. Sus tasas de completación de estudios y número de estudiantes es muy bajo. Como punto positivo, los costos por estudiar en estas instituciones tambien son muy bajos, aunque curiosamente, es un poco más costoso estudiar en instituciones públicas que en instituciones privadas. Cerca del 50% de los estudiantes recibe préstamos del estado, pero la deuda acumulada es muy baja, lo cual es debido posiblemente a los bajos costos de estas universidades. Sus puntajes de admision tambien son muy bajos. Se podría decir que a estas instituciones se puede entrar muy fácilmente.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#para visualizar cada cluster por separado, cambiar el siguiente numero:
cluster_number = 3
df_cluster_mean = df_norm[cluster_number,]
df_cluster_mean <- rbind(rep(max(df_norm), 9), rep(0, 9), df_cluster_mean)

radarchart(df_cluster_mean, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1,
           plwd = 2)

```

El cluster 2 tiene los puntajes de admision mas altos, al igual que la tasa de completación de estudios mas alta, pero su tasa de admisión es la mas baja, y cuenta con pocos estudiantes. Cerca del 80% de los estudiantes recibe préstamos del estado, y además, el costo de estudiar en universidades privadas de este grupo es excesivamente alto, razón por la cual se puede explicar que la deuda acumulada sea bastante alta también. Se podría decir que es un grupo de universidades exclusivo.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#para visualizar cada cluster por separado, cambiar el siguiente numero:
cluster_number = 4
df_cluster_mean = df_norm[cluster_number,]
df_cluster_mean <- rbind(rep(max(df_norm), 9), rep(0, 9), df_cluster_mean)

radarchart(df_cluster_mean, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1,
           plwd = 2)

```

El cluster 3 es más interesante que los anteriores. Su número de estudiantes es muy bajo, pero en todos los demás aspectos es bastante equilibrado. El costo de estudiar en instituciones privadas de este grupo es intermedio, y en instituciones públicas es un poco inferior. Cerca del 50% de los estudiantes de este grupo tienen préstamos, pero aun así, la deuda acumulada no es muy grande. Los puntajes de admisión son relativamente altos, y la tasa de admisión está derca del 20%. La tasa de completación está cerca del 40%

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#para visualizar cada cluster por separado, cambiar el siguiente numero:
cluster_number = 5
df_cluster_mean = df_norm[cluster_number,]
df_cluster_mean <- rbind(rep(max(df_norm), 9), rep(0, 9), df_cluster_mean)

radarchart(df_cluster_mean, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1,
           plwd = 2)

```

El cluster 4...

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#para visualizar cada cluster por separado, cambiar el siguiente numero:
cluster_number = 6
df_cluster_mean = df_norm[cluster_number,]
df_cluster_mean <- rbind(rep(max(df_norm), 9), rep(0, 9), df_cluster_mean)

radarchart(df_cluster_mean, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1,
           plwd = 2)

```

El cluster #5 esta caracterizado por un nivel de admision(ADM_RATE_ALL) alto(cercano al 80%), en otras competencias academicas se puede observar que en promedio hay un desempeño bajo en las pruebas academicas(SAT_AVG) y en cuanto al desempeño esperado (C150_4) solo cerca del 50% logran cumplir con lo esperado.
En otras competencias como en lo financiero podemos ver:
los costos de estudio en universidades publicas (NPT4_PUB) son bajos, lo contrario que en las universidades privadas (NPT4_PRIV) los cuales son muy altos, aun así los ingresos netos de universidades por estudiante(TUITFTE) son medianamente bajos 
Ademas el promedio de la deuda de los estudiantes y el promedio de estudiantes que recibieron prestamos federales son bastante altos.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#para visualizar cada cluster por separado, cambiar el siguiente numero:
cluster_number = 7
df_cluster_mean = df_norm[cluster_number,]
df_cluster_mean <- rbind(rep(max(df_norm), 9), rep(0, 9), df_cluster_mean)

radarchart(df_cluster_mean, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1,
           plwd = 2)

```

El cluster #6 se puede ver caracterizado por un nivel de admision (ADM_RATE_ALL) muy alto(cercano al 100%) pero en otros aspectos academicos podemos ver que en cuanto al desempeño en su carrera(c150_4) es bastante bajo, ya que pocos logran cumplir con lo esperado, ademas se observa un desempeño promedio en las pruebas escolares (SAT_AVG) bastante bajo 
En cuanto a aspectos econmicos de las universidades:
Este grupo se caracteriza por tener costos tanto en privadas como publicas (NPT4_PUB Y NPT4_PRIV) bajos, ademas de ingresos por estudiantes (TUITFTE) de igual manera bajos
en cuanto a las deudas promedios de los estudiante(DEBT_MDN) tambien son bajas y el numero de estudiantes que han recibido prestamos federales es medio

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#para visualizar cada cluster por separado, cambiar el siguiente numero:
cluster_number = 8
df_cluster_mean = df_norm[cluster_number,]
df_cluster_mean <- rbind(rep(max(df_norm), 9), rep(0, 9), df_cluster_mean)

radarchart(df_cluster_mean, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1,
           plwd = 2)

```

El cluster #7 se caracteriza por tener un nivel de admisiones (ADM_RATE_ALL) muy alto (cercano al 100%), en cuanto a otros aspectos academicos el desempeño en su carrera(C150_4) y el desempeño en pruebas escolares es bastante bajo.
En aspecto economicos de las universidades:
El costo en universidades publicas (NPT4_PUB) es bajo, pero en universidades privadas (NPT4_PRIV) el costo es alto, sin embargo en este grupo el promedio de ingresos por estudiante en la universidad(TUITFTE) lo podemos considerar bajo
Con una deuda promedio en la universidad por todos los estudiantes (DEBT_MDN) con un valor medio, la mayoria de los estudiantes han recibido ayudas federales

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#para visualizar cada cluster por separado, cambiar el siguiente numero:
cluster_number = 9
df_cluster_mean = df_norm[cluster_number,]
df_cluster_mean <- rbind(rep(max(df_norm), 9), rep(0, 9), df_cluster_mean)

radarchart(df_cluster_mean, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1,
           plwd = 2)

```

El cluster #8 se ve caracterizado por un nivel de admisiones (ADM_RATE_ALL) bueno (cercano al 70%), ademas de esto tanto en el desempeño en la carrera (C150_4) como en el desempeño en pruebas academicas se ve un valor medio
En cuanto a los aspectos economicos:
Apesar de que los costos en universidades privadas(NPT4_PRIV) como en universidades publicas (NPT4_PUB) se podrian considerar altos, el numero de ingresos por estudiante en la universidad (TUITFTE) es bastante bajo 
mientras que la deuda promedio de prestamo por todos los estudiantes (DEBT_MDN) y el numero de estudiantes que recibieron prestamos federales (PCTFLOAN) tienen un valor medio 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#para visualizar cada cluster por separado, cambiar el siguiente numero:
cluster_number = 10
df_cluster_mean = df_norm[cluster_number,]
df_cluster_mean <- rbind(rep(max(df_norm), 9), rep(0, 9), df_cluster_mean)

radarchart(df_cluster_mean, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1,
           plwd = 2)

```

El cluster 9...

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#para visualizar cada cluster por separado, cambiar el siguiente numero:
cluster_number = 11
df_cluster_mean = df_norm[cluster_number,]
df_cluster_mean <- rbind(rep(max(df_norm), 9), rep(0, 9), df_cluster_mean)

radarchart(df_cluster_mean, 
           seg = 9,  # Number of axis segments
           title = "Clusters de universidades",
           pcol = 1,
           plwd = 2)

```

# Referencias

https://rpubs.com/juliasilge/207156
https://rpubs.com/juliasilge/216478

